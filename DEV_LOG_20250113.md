# 개발 일지 (Dev Log) - 2025-01-13

## 개발 목표

오늘의 핵심 개발 목표는 **PDFusion ver_5**의 파일 처리 로직을 개선하는 것이었습니다:

1. **Word Test A/B 파일 선택 기능**: 여러 버전(Word Test A, Word Test B)이 있을 때 사용자가 선택할 수 있는 기능
2. **필수 파일 누락 시 유연한 처리**: 필수 파일이 없어도 사용자 선택에 따라 병합을 계속 진행할 수 있는 기능
3. **Word Test 압축 파일 자동 처리**: Word Test 파일이 zip 파일로 있을 때 자동으로 압축 해제하여 포함시키는 기능

---

## 주요 시도 및 시행착오 (Trial & Error)

### 1. Word Test A/B 선택 질문이 나오지 않는 문제

**문제 상황:**
```
[Word Test] (2개)
  1. Bricks Reading 170 Nonfiction_L1_Word Test\Bricks Reading 170 Nonfiction_L1_Word Test A.pdf
  2. Bricks Reading 170 Nonfiction_L1_Word Test\Bricks Reading 170 Nonfiction_L1_Word Test B.pdf
```
- Word Test A와 B 파일이 모두 있는데도 사용자 선택 질문이 표시되지 않음
- `[3-5단계] 유닛 정보 추출` 단계에서 `has_letter_suffix` 감지 로직이 제대로 작동하지 않음

**시도한 해결 방법:**
1. 정규표현식 패턴 수정: `r'\b[A-Z]\b'` → `r'[_\s]([A-Z])$'` (파일명 끝의 단일 알파벳만 감지)
2. `has_letter_suffix` 변수 스코프 문제 해결: 함수 레벨에서 초기화
3. `[3-3.6단계] Word Test 파일 처리` 로직을 별도로 추가하여 Unit Test 처리 직후에 실행

**최종 해결:**
- `[3-3.5단계] Unit Test 파일 처리` 직후에 `[3-3.6단계] Word Test 파일 처리` 로직 추가
- Word Test A/B 파일을 감지하고 사용자에게 선택 옵션 제공 (A만, B만, 둘 다 사용)

### 2. 필수 파일 누락 시 병합 중단 문제

**문제 상황:**
```
Bricks Reading 50 Nonfiction Level 3 교재를 진행하려 보니, 
이 폴더 안에는 Word Writing Sheet이 없어서 pdf 병합 진행이 되지 않았어.
```
- RC 타입, 책 번호 ≤ 60인 경우 Word Writing이 필수 파일로 설정됨
- Word Writing이 없으면 `None` 반환 → 병합 중단
- 하지만 실제로는 Word Test 파일이 있어도 병합이 가능해야 함

**에러 메시지:**
```
❌ [오류] 필수 파일이 누락되었습니다!
   누락된 파일 패턴: word\s*writing
⚠️  필수 파일이 없으면 병합을 진행할 수 없습니다.
```

**시도한 해결 방법:**
1. `get_files_for_level` 메서드에 `skip_required_check` 매개변수 추가
2. 필수 파일 누락 시 `None` 반환 → `config_v5.py`에서 사용자 선택 처리
3. 선택적 필수 그룹 시스템 도입: Word Writing 또는 Word Test 중 하나만 있어도 OK

**최종 해결:**
- 필수 파일 검증 로직을 선택적으로 만들고, 누락 시 사용자에게 계속 진행할지 선택권 제공
- 선택적 필수 그룹: `[r'word\s*writing', r'word\s*test']` - 둘 중 하나라도 있으면 OK

### 3. Word Test 파일이 압축 파일로 있어서 포함되지 않는 문제

**문제 상황:**
```
Bricks Reading 50 Nonfiction_L3_Word Test
이게 폴더 명인데 압축 해제되어있지 않았습니다.
```
- Word Test 파일이 `Bricks Reading 50 Nonfiction_L3_Word Test.zip`으로 존재
- 내부 zip 필터링 로직에서 Word Test가 제외되어 압축 해제되지 않음
- 결과적으로 Word Test 파일이 병합에 포함되지 않음

**원인 분석:**
- `config_v5.py`의 내부 zip 필터링 로직에서 책 번호 ≤ 60인 경우:
  ```python
  target_patterns = ['word list', 'word writing', 'translation sheet', 'unscramble sheet', 'unit test', ...]
  ```
  - **Word Test가 포함되지 않음!**

**최종 해결:**
- 내부 zip 필터링 패턴에 `'word test'` 추가
- 이제 Word Test zip 파일도 자동으로 발견되고 압축 해제됨

---

## 해결책 및 배운 점

### 1. 단계별 파일 처리 로직의 중요성

**배운 점:**
- 특정 파일 타입(Unit Test, Word Test)은 일반적인 파일 처리 로직보다 먼저 처리해야 함
- `[3-3.5단계]`, `[3-3.6단계]`처럼 단계를 세분화하여 각 파일 타입의 특수성을 처리

**구현 코드:**
```python
# [3-3.5단계] Unit Test 특별 처리
if 'Unit Test' in categories:
    # ALL 파일 vs 개별 Unit 파일 선택 로직
    
# [3-3.6단계] Word Test 파일 처리
if 'Word Test' in categories:
    # A 타입 vs B 타입 선택 로직
```

### 2. 유연한 필수 파일 검증 시스템

**배운 점:**
- 모든 파일을 필수로 만들면 실제 상황에서 유연성이 떨어짐
- 선택적 필수 그룹(Optional Required Groups) 개념 도입으로 유연성 확보

**구현 코드:**
```python
# 필수 파일
required_patterns = [
    r'word\s*list',
    r'translation\s*sheet',
    r'unscramble\s*sheet',
    r'unit\s*test',
]

# 선택적 필수 그룹 (둘 중 하나만 있어도 OK)
optional_required_groups = [
    [r'word\s*writing', r'word\s*test'],
]
```

### 3. 책 번호 기반 규칙의 일관성 유지

**배운 점:**
- 파일 필터링 로직과 내부 zip 필터링 로직이 동일한 규칙을 사용해야 함
- 한 곳에서만 수정하면 다른 곳에서 누락될 수 있음

**해결 방법:**
- `level_config.py`와 `config_v5.py`의 패턴을 동기화
- 책 번호 ≤ 60인 경우: Word Writing과 Word Test 둘 다 포함 패턴에 추가

---

## 최종 결과

### 구현된 기능

1. ✅ **Word Test A/B 선택 기능**
   - `[3-3.6단계] Word Test 파일 처리` 로직 추가
   - A 타입, B 타입, 또는 둘 다 사용 옵션 제공

2. ✅ **필수 파일 누락 시 사용자 선택 기능**
   - 필수 파일이 없어도 사용자가 계속 진행할지 선택 가능
   - 선택적 필수 그룹 시스템으로 Word Writing/Word Test 중 하나만 있어도 OK

3. ✅ **Word Test 압축 파일 자동 처리**
   - 내부 zip 필터링에 Word Test 추가
   - Word Test zip 파일 자동 발견 및 압축 해제

### 현재 동작 흐름

```
[3-1단계] LC/RC 감지
[3-2단계] 레벨 감지
[3-2.5단계] 내부 압축 파일 처리 (Word Test zip 포함)
[3-3단계] 파일 탐색 및 분류
[3-3.5단계] Unit Test 파일 처리 (ALL vs 개별 Unit 선택)
[3-3.6단계] Word Test 파일 처리 (A vs B vs 둘 다 선택) ← 새로 추가
[3-4단계] 파일 목록 확인
[3-5단계] 유닛 정보 추출
```

---

## To-Do: 앞으로 더 개선해야 할 점

### 1. 복잡한 규칙 시스템 개선

**현재 문제:**
- 책 번호와 레벨 조합에 따른 복잡한 규칙이 하드코딩되어 있음
- 예: "Bricks Reading 50 Nonfiction Level 3"에서는 Word Test도 필요
- 새로운 조합이 생길 때마다 코드 수정 필요

**개선 방안:**
- **설정 파일 기반 규칙 관리 (JSON/YAML)**
  ```json
  {
    "rules": [
      {
        "book_number_range": [1, 60],
        "level": "Level 3",
        "include": ["word list", "word test", "word writing", ...],
        "required": ["word list", "translation sheet", ...],
        "optional_groups": [["word writing", "word test"]]
      }
    ]
  }
  ```

### 2. 파일 존재 기반 자동 감지

**개선 방안:**
- 포함 패턴에 있는 파일이 실제로 존재하면 자동 포함
- 필수 검증은 완화 (핵심 파일만 필수)
- 사용자 개입 최소화

### 3. 로그 및 디버깅 개선

**개선 방안:**
- Word Test 관련 파일 발견 여부를 더 명확하게 로그에 표시
- 필터링 과정에서 각 파일이 포함/제외된 이유를 상세히 기록
- 사용자가 문제를 쉽게 파악할 수 있도록 개선

### 4. 에러 처리 강화

**개선 방안:**
- 필수 파일 누락 시 더 명확한 안내 메시지
- 사용자가 어떤 파일이 필요한지 쉽게 이해할 수 있도록 개선
- 파일명 패턴 매칭 실패 시 대안 제시

### 5. 코드 중복 제거

**개선 방안:**
- `level_config.py`와 `config_v5.py`의 패턴 정의를 중앙화
- 규칙 정의를 한 곳에서 관리하여 일관성 유지
- DRY (Don't Repeat Yourself) 원칙 적용

---

## 참고 파일

- `pdfusion/config_v5.py`: 메인 설정 관리 로직
- `pdfusion/level_config.py`: 레벨별 파일 규칙 정의
- `pdfusion/file_discovery.py`: 파일 탐색 및 분류
- `pdfusion/extractor.py`: zip 파일 압축 해제

---

**작성일:** 2025-01-13  
**버전:** PDFusion ver_5
